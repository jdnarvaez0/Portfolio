---
/**
 * Projects Page - All projects with search and filter
 */
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import ProjectCard from "../../components/ProjectCard.astro";
import { getAllProjects, getAllTags } from "../../data/projects";
import { t } from "../../i18n/translations";

const lang = "en";
const projects = getAllProjects().slice(0, 2);
const tags = getAllTags();

// Get project count
const projectCount = projects.length;
---

<BaseLayout
  title="Projects | Juan Narvaez"
  description="Explore my open-source projects and repositories"
  lang={lang}
>
  <Header />

  <main class="container">
    <!-- Page Header -->
    <section class="page-header">
      <div class="header-content">
        <h1 class="page-title">{t(lang, "sections.projects")}</h1>
        <a
          href="https://github.com/jdnarvaez0"
          target="_blank"
          rel="noopener noreferrer"
          class="github-link-header"
        >
          <span>View on GitHub</span>
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
            ></path>
            <polyline points="15,3 21,3 21,9"></polyline>
            <line x1="10" y1="14" x2="21" y2="3"></line>
          </svg>
        </a>
      </div>

      <!-- Search Bar -->
      <div class="search-container">
        <svg
          class="search-icon"
          xmlns="http://www.w3.org/2000/svg"
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        <input
          type="text"
          class="search-input"
          placeholder="Search projects..."
          id="search-input"
          autocomplete="off"
        />
      </div>

      <!-- Stats -->
      <div class="stats-bar">
        <div class="stats-item">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="6" y1="3" x2="6" y2="15"></line>
            <circle cx="18" cy="6" r="3"></circle>
            <circle cx="6" cy="18" r="3"></circle>
            <path d="M18 9a9 9 0 0 1-9 9"></path>
          </svg>
          <span id="project-count">{projectCount} repositories</span>
        </div>
      </div>
    </section>

    <!-- Projects Grid -->
    <section class="projects-section">
      <div class="projects-grid" id="projects-grid">
        {
          projects.map((project) => (
            <ProjectCard
              name={project.name}
              emoji={project.emoji}
              description={project.description[lang]}
              github={project.github}
              url={project.url}
              tags={project.tags}
              updated={project.updated}
            />
          ))
        }
      </div>

      <!-- No results message -->
      <div class="no-results" id="no-results" style="display: none;">
        <p>No projects found matching your search.</p>
      </div>
    </section>
  </main>
</BaseLayout>

<style>
  .page-header {
    padding-top: 2rem;
    margin-bottom: 2rem;
  }

  .header-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }

  .page-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .github-link-header {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    color: var(--text-muted);
    text-decoration: none;
    transition: color 150ms ease;
  }

  .github-link-header:hover {
    color: var(--text-primary);
  }

  /* Search Container */
  .search-container {
    position: relative;
    margin-bottom: 1rem;
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 2.75rem;
    font-size: 0.9375rem;
    font-family: var(--font-sans);
    color: var(--text-primary);
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    transition:
      border-color 200ms ease,
      background-color 200ms ease;
  }

  .search-input::placeholder {
    color: var(--text-muted);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--border-color-hover);
    background: var(--bg-card-hover);
  }

  /* Stats Bar */
  .stats-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color);
  }

  .stats-item {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  /* Projects Section */
  .projects-section {
    padding-bottom: 4rem;
  }

  .projects-grid {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  @media (max-width: 640px) {
    .projects-grid {
      gap: 0.625rem;
    }

    .header-content {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }
  }

  /* No Results */
  .no-results {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-muted);
  }

  .no-results p {
    font-size: 0.9375rem;
  }
</style>

<script>
  // Client-side search functionality
  const searchInput = document.getElementById(
    "search-input",
  ) as HTMLInputElement;
  const projectsGrid = document.getElementById("projects-grid") as HTMLElement;
  const noResults = document.getElementById("no-results") as HTMLElement;
  const projectCount = document.getElementById("project-count") as HTMLElement;

  // Get all project cards
  const allCards = Array.from(projectsGrid.querySelectorAll(".project-card"));

  function filterProjects(query: string) {
    const lowerQuery = query.toLowerCase().trim();
    let visibleCount = 0;

    allCards.forEach((card) => {
      const name =
        card.querySelector(".project-name, .project-name-text")?.textContent ||
        "";
      const description =
        card.querySelector(".project-description")?.textContent || "";
      const tags = Array.from(card.querySelectorAll(".tech-name"))
        .map((t) => t.textContent)
        .join(" ");

      const searchableText = `${name} ${description} ${tags}`.toLowerCase();
      const isMatch = searchableText.includes(lowerQuery);

      (card as HTMLElement).style.display = isMatch ? "" : "none";
      if (isMatch) visibleCount++;
    });

    // Update count
    const countText =
      visibleCount === 1 ? "1 repository" : `${visibleCount} repositories`;
    if (projectCount) projectCount.textContent = countText;

    // Show/hide no results message
    if (noResults) {
      noResults.style.display = visibleCount === 0 ? "block" : "none";
    }
  }

  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement;
      filterProjects(target.value);
    });
  }
</script>
